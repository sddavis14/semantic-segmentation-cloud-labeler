<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point Cloud Labeler</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css?v=25">
</head>

<body>
    <div id="app">
        <!-- Top Toolbar -->
        <header class="toolbar">
            <div class="toolbar-section">
                <button id="btn-open" class="btn btn-primary" title="Open Folder (Ctrl+O)">
                    <span class="icon">üìÇ</span> Open
                </button>
                <button id="btn-save" class="btn" title="Save Labels (Ctrl+S)">
                    <span class="icon">üíæ</span> Save
                </button>
                <button id="btn-reset" class="btn" title="Discard changes and reload file">
                    <span class="icon">‚Ü©Ô∏è</span> Reset
                </button>
                <div class="tool-group">
                    <span class="label">Format:</span>
                    <select id="save-format" title="Output format for saved files">
                        <option value="">Auto (preserve)</option>
                        <option value="ascii">ASCII</option>
                        <option value="binary">Binary</option>
                        <option value="binary_compressed">Compressed</option>
                    </select>
                </div>
                <div class="separator"></div>
                <div class="tool-group">
                    <span class="label">Selection:</span>
                    <button id="btn-box-select" class="btn tool-btn active" title="Box Select (B)">
                        <span class="icon">‚ñ¢</span> Box
                    </button>
                    <button id="btn-lasso-select" class="btn tool-btn" title="Lasso Select (L)">
                        <span class="icon">„Ä∞</span> Lasso
                    </button>
                </div>
                <div class="separator"></div>
                <div class="tool-group">
                    <span class="label">Color by:</span>
                    <select id="colorize-mode">
                        <option value="label">Label</option>
                        <!-- Additional fields populated dynamically -->
                    </select>
                </div>
                <div class="tool-group color-bounds-controls" id="color-bounds-controls" style="display: none;">
                    <span class="label">Min:</span>
                    <input type="range" id="color-min" min="0" max="1" value="0" step="0.001">
                    <span id="color-min-value" class="bound-value">0</span>
                    <span class="label">Max:</span>
                    <input type="range" id="color-max" min="0" max="1" value="1" step="0.001">
                    <span id="color-max-value" class="bound-value">1</span>
                    <button id="btn-reset-bounds" class="btn btn-sm" title="Reset to auto-detected bounds">‚ü≤</button>
                </div>
                <div class="tool-group">
                    <span class="label">Size:</span>
                    <input type="range" id="point-size" min="0" max="1" value="0.5" step="0.01" title="Point Size">
                    <span id="point-size-value">0.05</span>
                </div>
                <button id="btn-reset-view" class="btn" title="Reset Camera (R)">
                    <span class="icon">üéØ</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- File Tree Panel -->
            <aside id="file-tree-panel" class="file-tree-panel">
                <div class="panel-header">
                    <h3>Files</h3>
                </div>
                <div id="file-tree" class="file-tree">
                    <div class="file-tree-empty">Click "Open" to select a folder</div>
                </div>
            </aside>

            <!-- 3D Viewport -->
            <div id="viewport">
                <!-- Help hint overlay -->
                <div class="help-hint">Press <kbd>H</kbd> for help</div>
                <!-- PCD format badge -->
                <div id="pcd-format-badge" class="pcd-format-badge hidden">ASCII</div>
            </div>

            <!-- Label Panel -->
            <aside class="label-panel">
                <h3>Labels</h3>
                <div id="label-buttons"></div>
                <div class="label-actions">
                    <button id="btn-clear-selection" class="btn btn-small">Clear Selection (Esc)</button>
                </div>
                <div class="label-config-menu">
                    <div class="config-menu-header">
                        <span class="config-label">Config:</span>
                        <span id="current-config-name" class="config-name">default</span>
                    </div>
                    <div class="config-menu-buttons">
                        <button id="btn-load-config" class="btn btn-small" title="Load config from YAML file">üìÇ
                            Load</button>
                        <button id="btn-edit-labels" class="btn btn-small" title="Edit current labels">‚úèÔ∏è Edit</button>
                        <button id="btn-new-config" class="btn btn-small" title="Create new config">‚ûï New</button>
                        <button id="btn-save-config-as" class="btn btn-small" title="Save config to file">üíæ Save
                            As</button>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <span id="status-file">No file loaded</span>
                <span id="status-points">0 points</span>
                <span id="status-selection">0 selected</span>
                <span id="status-mode">Box Select</span>
            </div>
            <div class="status-center">
                <span id="status-filename">No file loaded</span>
            </div>
            <div class="status-right nav-controls">
                <button id="btn-prev" class="btn btn-sm" title="Previous File (‚Üê)">
                    <span class="icon">‚óÄ</span>
                </button>
                <span id="file-progress" class="file-progress">0 / 0</span>
                <button id="btn-next" class="btn btn-sm" title="Next File (‚Üí)">
                    <span class="icon">‚ñ∂</span>
                </button>
            </div>
        </footer>

        <!-- Selection Overlay Canvas -->
        <canvas id="selection-overlay"></canvas>

        <!-- Label Config Modal -->
        <div id="label-config-modal" class="modal hidden">
            <div class="modal-content">
                <h2>Configure Labels</h2>
                <div id="label-config-list"></div>
                <div class="modal-actions">
                    <button id="btn-add-label" class="btn">+ Add Label</button>
                    <button id="btn-save-config" class="btn btn-primary">Save</button>
                    <button id="btn-cancel-config" class="btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Folder Select Modal -->
        <div id="folder-modal" class="modal hidden">
            <div class="modal-content folder-browser">
                <div class="folder-browser-header">
                    <h2>üìÅ Open Folder</h2>
                    <button id="btn-folder-close" class="btn-close" title="Close">√ó</button>
                </div>

                <div class="folder-browser-body">
                    <!-- Sidebar -->
                    <div class="folder-sidebar">
                        <div class="sidebar-section">
                            <div class="sidebar-title">Favorites</div>
                            <div id="folder-favorites" class="sidebar-items">
                                <div class="sidebar-item" data-path="~">
                                    <span class="sidebar-icon">üè†</span>
                                    <span>Home</span>
                                </div>
                                <div class="sidebar-item" data-path="~/Desktop">
                                    <span class="sidebar-icon">üñ•Ô∏è</span>
                                    <span>Desktop</span>
                                </div>
                                <div class="sidebar-item" data-path="~/Documents">
                                    <span class="sidebar-icon">üìÑ</span>
                                    <span>Documents</span>
                                </div>
                            </div>
                        </div>
                        <div class="sidebar-section">
                            <div class="sidebar-title">Recent</div>
                            <div id="folder-recent" class="sidebar-items">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="folder-main">
                        <!-- Breadcrumb Navigation -->
                        <div class="folder-breadcrumb" id="folder-breadcrumb">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Filter -->
                        <div class="folder-filter">
                            <input type="text" id="folder-filter-input" placeholder="üîç Filter folders..." />
                        </div>

                        <!-- Folder List -->
                        <div id="folder-list" class="folder-list" tabindex="0">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Info Bar -->
                        <div id="folder-info" class="folder-info">
                            Select a folder containing .pcd files
                        </div>
                    </div>
                </div>

                <div class="folder-browser-footer">
                    <input type="text" id="folder-path-input" placeholder="Or enter path directly..." />
                    <div class="modal-actions">
                        <button id="btn-folder-cancel" class="btn">Cancel</button>
                        <button id="btn-folder-open" class="btn btn-primary">Open</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Overlay -->
    <div id="shortcuts-overlay" class="shortcuts-overlay hidden">
        <div class="shortcuts-content">
            <div class="shortcuts-header">
                <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
                <button class="btn-close"
                    onclick="document.getElementById('shortcuts-overlay').classList.add('hidden')">&times;</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcuts-section">
                    <h3>Navigation</h3>
                    <div class="shortcut-item"><kbd>N</kbd> / <kbd>Right Arrow</kbd> Next file</div>
                    <div class="shortcut-item"><kbd>P</kbd> / <kbd>Left Arrow</kbd> Previous file</div>
                    <div class="shortcut-item"><kbd>R</kbd> Reset view</div>
                </div>
                <div class="shortcuts-section">
                    <h3>Selection</h3>
                    <div class="shortcut-item"><kbd>B</kbd> Box select mode</div>
                    <div class="shortcut-item"><kbd>L</kbd> Lasso select mode</div>
                    <div class="shortcut-item"><kbd>Esc</kbd> Clear selection</div>
                </div>
                <div class="shortcuts-section">
                    <h3>Labels</h3>
                    <div class="shortcut-item"><kbd>1</kbd>-<kbd>9</kbd> Select current label</div>
                    <div class="shortcut-item"><kbd>0</kbd> Unlabeled</div>
                    <div class="shortcut-item"><kbd>C</kbd> Cycle color mode</div>
                </div>
                <div class="shortcuts-section">
                    <h3>File</h3>
                    <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>S</kbd> Save</div>
                    <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>O</kbd> Open folder</div>
                    <div class="shortcut-item"><kbd>?</kbd> Show shortcuts</div>
                </div>
            </div>
            <div class="shortcuts-footer">
                Press <kbd>?</kbd> or <kbd>Esc</kbd> to close
            </div>
        </div>
    </div>

    <!-- Three.js (only core - PCD loading is via native parser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Modified TrackballControls: right-click=rotate, middle=zoom, left-click=FREE -->
    <script src="js/TrackballControls.js?v=2"></script>

    <!-- App Scripts -->
    <script src="js/colorizer.js?v=23"></script>
    <script src="js/labels.js?v=20"></script>
    <script src="js/selection.js?v=20"></script>
    <script src="js/viewer.js?v=30"></script>
    <script src="js/file-browser.js?v=20"></script>
    <script src="js/folder-modal.js?v=1"></script>
    <script src="js/app.js?v=40"></script>
</body>

</html>